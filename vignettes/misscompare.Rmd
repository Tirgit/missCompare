---
title: "Introduction to missCompare"
author: "Tibor V. Varga"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{missCompare}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
devtools::load_all()
```


Section of missing data imputation in general.

* xxxx
* yyyy

Now, let's begin by installing and loading the missCompare package!


## Description of data: *clindata_full* and *clindata_miss*

To walk you through the missCompare missing data imputation comparison pipeline, the authors created
the `missCompare::clindata_full` and `missCompare::clindata_miss` dataframes. As the names suggest, while clindata_miss contains missing data, clindata_full does not. You can load them into your workspace by:

```{r eval = TRUE}
data("clindata_full")
data("clindata_miss")
```

The data is created by the authors with the purpose of generating a dataset that resembles a real-life
dataset with variables generally available in realistic clinicial epidemiology datasets. The datasets
have "believable" variable means, distributions, correlations and in clindata_miss, realistic
missing data patterns. You can find further information on these datasets and the variables within
using `?clindata_full` and `?clindata_miss`.


## The missCompare pipeline

The missCompare pipeline is comprised of the following steps:

1. **Cleaning your data** using `missCompare::clean()`
2. **Extracting information** on dimensions, missingness, correlations and variables and plotting
missing data using `missCompare::get_data()`
3. **Imputation - simulated data**:
  + simulating full data with no missingness using metadata from the previous step (resembling your original data) using `missCompare::simulated()`
  + spiking in missing data in distinct missing data patterns using `missCompare::all_patterns()`. These patterns are:
    + missing completely at random (MCAR) - `missCompare::MCAR()` - missing data occurence random
    + missing at random (MAR) - `missCompare::MAR()` - missing data occurence correlates with other variables' values (univariate solution in missCompare)
    + missing not at random (MNAR) - `missCompare::MNAR()` - missing data occurence correlates with variables' own values
    + missing in assumed pattern (MAP) - `missCompare::MAP()` - a combination of the previous three, where the user can define a pattern per variable
  + imputing missing data and obtaining imputation accuracy (root mean squared errors - RMSE) and plot using `missCompare::impute_simulated()`
4. **Imputation - validation** - After the previous step, you will have a general idea on what are the best performing algorithms for your data structure (size, degree of correlation between variables). With `missCompare::impute_data_validate()` you can use your original data and spike in a tiny fraction of missing data, impute and check imputation accuracy on that tiny fraction and validate that the best performing algorithms from the previous step are indeed good to work with.
5. **Imputating your data** - Here you can impute your original data with your chosen algorithm(s) using `missCompare::impute_data()`.
6. **Post imputation diagnostics** will give an informative assessment on how the imputation changed your data structure (e.g. variable means, distributions, correlations). The function here is `missCompare::post_imp_diag()`.


## Cleaning and getting to know the data

The first step before starting anything imputation related is getting to know your data and cleaning it if necessary. This is not an "automated" process, nor should it be. You always need to explore your data before missing data imputation - it is entirely up to you what to keep and what to drop from your dataset before the imputation process. After the cleaning steps, missCompare will essentially reconstruct your dataset with no missing data, and in order to achieve this, your dataframe cannot have variables of type character or factor (in a later stage you will be able to use your original factor variables, but to extract metadata at this step, a conversion is necessary). 

Let's take clindata_miss and run `missCompare::clean()`. In one step, you can achieve multiple cleaning steps:

```{r eval = TRUE} 
cleaned <- missCompare::clean(clindata_miss, 
                  var_removal_threshold = 0.5, 
                  ind_removal_threshold = 0.8, 
                  missingness_coding = -9)
```

* You can convert all factor variables (sex and education, in this case) to numeric. The function will alert you with a message: **"Variable(s) sex, education converted to numeric."**
* You can remove variables exceeding a set threshold (default is 50\%, but this is up to you, you can set it lower or higher). In other words, you can discard those variables where lots of data are missing. Such variables can only be imputed with low accuracy, so the authors suggest that you remove variables with high missingness fraction, but there is no recipe for this, e.g. you will find no guidelines on whether 50\% is too high or too low, the threshold will be YOUR decision. In case there is a variable removed here, the function will alert you with a message: **Variable(s) PPG removed due to exceeding the pre-defined removal threshold (>50%) for missingness.**
* Similarly, you can remove individuals with a high percentage of missing values (default is 100\%, but this is up to you, you can set it lower). In other words, you can discard those observations that have only missing datapoints (these will be totally uninformative for imputation), or those with lots of missing data points. Again, there are no guidelines here, the threshold is ultimately YOUR decision. In this case, we set this threshold to 0.8, and the function alerted us with a message: **1 individual(s) removed due to exceeding the pre-defined removal threshold (>80%) for missingness.**
* In some datasets, missing values can be coded in a weird way. In clindata_miss, we emulated a real-life scenario where lipid values were set to **-9** when measured below the sensitivity of a hypothetical machine. The cleaning function will let you convert these values to **NAs**.

The cleaning function output the results to an R object called `cleaned`. This is list that contains one element, `cleaned$Dataframe_clean`, the cleaned dataframe. In the next step, where you extract important metadata from your dataframe, you will continue working with this object.

You will get to know important details of your cleaned dataframe using the following line:

```{r eval = TRUE} 
metadata <- missCompare::get_data(cleaned$Dataframe_clean, 
                                matrixplot_sort = T,
                                plot_transform = T)
```

If there are factor variables in the data, a warning will appear: **Warning! Variable(s) sex, education is/are not numeric. Convert this/these variables to numeric using missCompare::clean() and repeat the missCompare::get_data() function until no warnings are shown.**

As we cleaned clindata_miss in the previous step, the function should run without any warnings and errors. The output object, `metadata` is a list of the following elements.

* `metadata$Complete_cases` - the number of complete observations with no missing data. In this case, there are **1349 observations from the original 2500** with no missing data. Note, that with only ~10\% missing data, the number of complete observations is dramatically decreased to around half of the original data. As many methods (e.g. regression, principal component analysis, etc.) require complete sets of observations, this decrease in complete observations presents a very strong case for missing data imputation.
* `metadata$Rows` and `metadata$Columns` give you the dimensions of the dataframe, **2499 rows and 11 columns**, in our case.
* `metadata$Corr_matrix` - gives you the **correlation matrix of all variables** in the dataframe. The function assesses pairwise Pearson correlation coefficients using complete sets of pairs between any two variables. For example there are 2312 complete BMI-waist pairs (`sum(!is.na(cleaned$Dataframe_clean$BMI) & !is.na(cleaned$Dataframe_clean$waist))`) - in this case correlation will be calculated based on these 2312 value pairs, even though the number of complete observations is 1349. This way all of the data will be utilized to obtain the most accurate correlation coefficients.
* `metadata$Fraction_missingness` and `metadata$Fraction_missingness_per_variable` return the the total fraction of missingness in the dataframe and the fraction of missingness per variable, respectively. In our case, the **total fraction of missingess is 6.9\%** after removing one variable, PPG with >50\% missing. Inspecting the fraction of missingness per variable it is also apparent that the true missing data fraction of TG and HDL-C after converting -9s to NAs are 10.6\% and 13.7\%, respectively.
* `metadata$Total_NA` and `metadata$NA_per_variable` return the total number of missing values in the dataframe and per variable.
* `metadata$MD_Pattern` - The missing data pattern is calculated using mice::md.pattern.
* `metadata$Vars_above_half` - In case there are variables exceeding 50\% missingness, this object will list these variables and the function will output a warning: **"Warning! Missingness exceeds 50% for variable(s) PPG. Although the pipeline will function with variables with high missingness, consider excluding these variables using missCompare::clean() and repeating function until no warnings are shown.**
* `metadata$Matrix_plot` - Matrix plot (ggplot2 object) visualizing missing data distribution. There are options to sort the dataframe by missingness or leave the dataframe unsorted. This plot (hopefully) gives you a visual description of how data is missing together and what fraction of the data is missing.     
```{r echo = FALSE, fig.width=6, fig.height=3} 
metadata$Matrix_plot
```
* `metadata$Cluster_plot` - Dendrogram (ggplot2 object) visualizing the **hierarchical clustering of missing data**. On the plot, the clades (bifurcations) closer to Height 0 (the bottom of the plot) represent closer relationships in terms of missing data - i.e. those variables in one group are more likely to be missing together compared to the rest. In our case, blood pressures SBP and DPB are missing together often and so as the three lipid traits, TC, TG and HLD-C. With respect to the other variables, waist and BMI have a closer relationship compared to the rest.    
```{r echo = FALSE, fig.width=6, fig.height=3} 
metadata$Cluster_plot
```




## Simulating a complete dataset and assessing algorithms

## Validating best performing algorithms

## Imputing your dataset

## Post imputation diagnostics





